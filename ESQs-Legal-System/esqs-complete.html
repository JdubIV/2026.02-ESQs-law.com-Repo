<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESQs - Enhanced Synthesized Quintessential System</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 50%, #1a202c 100%);
            color: white;
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: rgba(26, 54, 93, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            text-align: center;
            border-bottom: 3px solid #d4af37;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 0.5rem;
        }

        .tagline {
            font-size: 1.1rem;
            color: #e2e8f0;
            font-weight: 300;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
        }

        .sidebar {
            background: rgba(45, 55, 72, 0.8);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .chat-area {
            background: rgba(26, 32, 44, 0.8);
            border-radius: 15px;
            padding: 2rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.3);
            display: flex;
            flex-direction: column;
        }

        .quick-actions {
            margin-bottom: 2rem;
        }

        .quick-actions h3 {
            color: #d4af37;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .action-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #1a365d;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .action-btn:disabled {
            background: rgba(100, 100, 100, 0.5);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .processing-mode {
            margin-bottom: 2rem;
        }

        .processing-mode h3 {
            color: #d4af37;
            margin-bottom: 1rem;
        }

        .mode-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .mode-btn {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #d4af37;
            background: transparent;
            color: #d4af37;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .mode-btn.active {
            background: #d4af37;
            color: #1a365d;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 2rem;
            min-height: 300px;
            position: relative;
        }

        .message {
            background: rgba(45, 55, 72, 0.6);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            border-left: 4px solid #d4af37;
        }

        .message.user {
            background: rgba(212, 175, 55, 0.2);
            border-left: 4px solid #e2e8f0;
            margin-left: 2rem;
        }

        .message-timestamp {
            display: block;
            font-size: 0.7rem;
            color: rgba(226, 232, 240, 0.45);
            margin-top: 0.5rem;
            text-align: right;
            font-style: italic;
            letter-spacing: 0.3px;
        }

        .message.user .message-timestamp {
            color: rgba(212, 175, 55, 0.5);
        }

        .query-input-area {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .query-input {
            flex: 1;
            background: rgba(45, 55, 72, 0.8);
            border: 2px solid rgba(212, 175, 55, 0.5);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            min-height: 60px;
        }

        .query-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .send-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #1a365d;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .send-btn:disabled {
            background: rgba(100, 100, 100, 0.5);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        /* FILE UPLOAD / DRAG-DROP */
        .query-input-area {
            position: relative;
        }

        .query-input-area.drag-over {
            border: 2px dashed #d4af37;
            border-radius: 12px;
            background: rgba(212, 175, 55, 0.05);
        }

        .drag-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(26, 54, 93, 0.9);
            border: 2px dashed #d4af37;
            border-radius: 12px;
            z-index: 10;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #d4af37;
            pointer-events: none;
        }

        .query-input-area.drag-over .drag-overlay {
            display: flex;
        }

        .attach-btn {
            background: none;
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: rgba(212, 175, 55, 0.7);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            align-self: end;
        }

        .attach-btn:hover {
            border-color: #d4af37;
            color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .file-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }

        .file-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(212, 175, 55, 0.15);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
            color: #d4af37;
        }

        .file-chip .remove-file {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .file-chip .remove-file:hover {
            opacity: 1;
        }

        /* CYNTHIA INTERFACE */
        .cynthia-interface {
            position: relative;
            margin-top: 1rem;
            padding: 1.5rem;
            background: rgba(26, 54, 93, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            min-height: 120px;
        }

        .cynthia-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            height: 80px;
            margin-bottom: 1rem;
        }

        /* REFLECTIVE CYNTHIA FACE */
        .cynthia-face {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, 
                rgba(255,255,255,0.9) 0%, 
                rgba(240,240,240,0.8) 30%,
                rgba(220,220,220,0.7) 70%,
                rgba(200,200,200,0.6) 100%);
            border: 2px solid #d4af37;
            box-shadow: 
                inset 0 0 20px rgba(255,255,255,0.3),
                0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }

        /* ACTUAL FACIAL FEATURES */
        .cynthia-eyes {
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 8px;
            transition: all 0.2s ease;
        }

        .cynthia-eyes::before,
        .cynthia-eyes::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: #2d3748;
            border-radius: 50%;
            top: 1px;
            transition: all 0.2s ease;
        }

        .cynthia-eyes::before {
            left: 6px;
        }

        .cynthia-eyes::after {
            right: 6px;
        }

        .cynthia-nose {
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 4px;
            background: rgba(45, 55, 72, 0.4);
            border-radius: 1px;
        }

        .cynthia-mouth {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 4px;
            border: 1px solid rgba(45, 55, 72, 0.5);
            border-top: none;
            border-radius: 0 0 12px 12px;
            background: rgba(45, 55, 72, 0.1);
            transition: all 0.1s ease;
        }

        /* TALKING ANIMATIONS */
        .cynthia-face.talking .cynthia-mouth {
            animation: mouthTalk 0.3s ease-in-out infinite;
        }

        .cynthia-face.mouse-following .cynthia-eyes {
            transition: transform 0.3s ease;
        }

        .cynthia-face.thinking .cynthia-eyes::before,
        .cynthia-face.thinking .cynthia-eyes::after {
            animation: eyeBlink 2s ease-in-out infinite;
        }

        .cynthia-face.thinking .cynthia-mouth {
            animation: mouthMove 2s ease-in-out infinite;
        }

        .cynthia-face.thinking {
            animation: cynthiaThink 2s ease-in-out infinite;
        }

        .face-reflection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                transparent 0%, 
                rgba(212, 175, 55, 0.2) 30%,
                rgba(255,255,255,0.4) 50%,
                rgba(212, 175, 55, 0.2) 70%,
                transparent 100%);
            opacity: 0.7;
            animation: reflection 3s ease-in-out infinite;
        }

        .query-reflection {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: rgba(26, 54, 93, 0.6);
            font-weight: bold;
            text-align: center;
            width: 90%;
            overflow: hidden;
            white-space: nowrap;
            opacity: 0;
        }

        .query-reflection.active {
            opacity: 1;
            animation: queryScroll 4s ease-in-out;
        }

        /* FALLING BOOKS ANIMATION */
        .books-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .book {
            position: absolute;
            width: 12px;
            height: 16px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            border: 1px solid #654321;
            border-radius: 2px;
            opacity: 0;
            transform: translateY(-20px) rotate(0deg);
        }

        .book:nth-child(1) {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            left: 10px;
        }

        .book:nth-child(2) {
            background: linear-gradient(135deg, #2F4F4F 0%, #708090 100%);
            left: 25px;
        }

        .book:nth-child(3) {
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
            left: 40px;
        }

        .book:nth-child(4) {
            background: linear-gradient(135deg, #006400 0%, #228B22 100%);
            left: 55px;
        }

        .books-container.dropping .book {
            animation: bookDrop 1.5s ease-in forwards;
        }

        .books-container.dropping .book:nth-child(1) {
            animation-delay: 0s;
        }

        .books-container.dropping .book:nth-child(2) {
            animation-delay: 0.2s;
        }

        .books-container.dropping .book:nth-child(3) {
            animation-delay: 0.4s;
        }

        .books-container.dropping .book:nth-child(4) {
            animation-delay: 0.6s;
        }

        .cynthia-response {
            background: rgba(45, 55, 72, 0.4);
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #d4af37;
            margin-top: 1rem;
            opacity: 0;
            transform: translateY(20px);
        }

        .cynthia-response.show {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.8s ease 1.2s;
        }

        .cynthia-label {
            color: #d4af37;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cynthia-label::before {
            content: "üß†";
            font-size: 1.2rem;
        }

        /* ANIMATIONS */
        @keyframes cynthiaThink {
            0%, 100% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(15deg) scale(1.05); }
        }

        @keyframes eyeBlink {
            0%, 90%, 100% { height: 6px; }
            95% { height: 1px; }
        }

        @keyframes mouthMove {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
        }

        @keyframes mouthTalk {
            0%, 100% { 
                height: 4px; 
                width: 12px;
                border-radius: 0 0 12px 12px;
            }
            50% { 
                height: 8px; 
                width: 14px;
                border-radius: 0 0 14px 14px;
            }
        }

        @keyframes reflection {
            0%, 100% { transform: translateX(-20px) skewX(-10deg); opacity: 0.3; }
            50% { transform: translateX(20px) skewX(10deg); opacity: 0.8; }
        }

        @keyframes queryScroll {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; }
        }

        @keyframes bookDrop {
            0% {
                opacity: 1;
                transform: translateY(-20px) rotate(0deg);
            }
            50% {
                transform: translateY(30px) rotate(180deg);
            }
            100% {
                opacity: 1;
                transform: translateY(60px) rotate(360deg);
            }
        }

        .status-indicators {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(45, 55, 72, 0.6);
            padding: 0.6rem 1rem;
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-ready {
            color: #68d391;
        }

        .status-processing {
            color: #f6e05e;
        }

        .status-error {
            color: #fc8181;
        }

        .status-offline {
            color: #a0aec0;
        }

        /* TOKEN USAGE INDICATOR */
        .token-usage {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(26, 32, 44, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .token-usage h4 {
            color: #d4af37;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .token-bar {
            background: rgba(45, 55, 72, 0.8);
            border-radius: 10px;
            height: 8px;
            margin: 0.3rem 0;
            overflow: hidden;
        }

        .token-fill {
            height: 100%;
            background: linear-gradient(90deg, #68d391 0%, #f6e05e 70%, #fc8181 100%);
            transition: width 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid #d4af37;
            max-width: 500px;
            width: 90%;
            color: white;
        }

        .modal h3 {
            color: #d4af37;
            margin-bottom: 1rem;
        }

        .modal-input {
            width: 100%;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border: 2px solid rgba(212, 175, 55, 0.5);
            border-radius: 8px;
            background: rgba(45, 55, 72, 0.8);
            color: white;
            font-size: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #1a365d;
        }

        .modal-btn.secondary {
            background: rgba(45, 55, 72, 0.8);
            color: white;
            border: 1px solid rgba(212, 175, 55, 0.5);
        }

        /* CODE BUILDER INTERFACE */
        .code-builder-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            backdrop-filter: blur(15px);
        }

        .code-builder-content {
            position: absolute;
            top: 5%;
            left: 5%;
            width: 90%;
            height: 90%;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            border-radius: 20px;
            border: 2px solid #d4af37;
            padding: 20px;
            color: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .code-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d4af37;
        }

        .code-builder-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d4af37;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .code-builder-title::before {
            content: "‚ö°";
            font-size: 2rem;
        }

        .code-builder-close {
            background: #dc3545;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .code-builder-main {
            display: flex;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }

        .code-input-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .code-output-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .code-builder-textarea {
            flex: 1;
            background: rgba(26, 32, 44, 0.9);
            border: 2px solid rgba(212, 175, 55, 0.5);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            resize: none;
            line-height: 1.5;
        }

        .code-builder-textarea:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .code-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .code-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #1a365d;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .code-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
        }

        .code-btn.danger {
            background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%);
            color: white;
        }

        .ai-status-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .ai-status-item {
            background: rgba(45, 55, 72, 0.8);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            text-align: center;
            font-size: 0.8rem;
        }

        .ai-status-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }

        .ai-status-item.processing {
            background: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            animation: pulse 1s ease-in-out infinite;
        }

        .code-output {
            flex: 1;
            background: rgba(26, 32, 44, 0.9);
            border: 2px solid rgba(212, 175, 55, 0.5);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .language-selector {
            background: rgba(45, 55, 72, 0.8);
            border: 2px solid rgba(212, 175, 55, 0.5);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .code-builder-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            font-size: 0.9rem;
            color: #a0aec0;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                flex-direction: column;
            }
            
            .query-input-area {
                flex-direction: column;
            }
            
            .cynthia-container {
                flex-direction: column;
                align-items: center;
                height: auto;
                gap: 1rem;
            }

            .status-indicators {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ESQs</div>
        <div class="tagline">Enhanced Synthesized Quintessential System - Digital Law Firm Intelligence</div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="status-indicators" id="statusIndicators">
                <div class="status-item">
                    <span class="status-offline">‚óè</span> Cynthia
                </div>
                <div class="status-item">
                    <span class="status-offline">‚óè</span> Claude
                </div>
                <div class="status-item">
                    <span class="status-offline">‚óè</span> OpenAI
                </div>
                <div class="status-item">
                    <span class="status-offline">‚óè</span> Gemini
                </div>
            </div>

            <div class="quick-actions">
                <h3>‚ö° Quick Actions</h3>
                <div class="action-grid">
                    <button class="action-btn" onclick="accessClient()">üë§ Access Client</button>
                    <button class="action-btn" onclick="startBilling()">üí∞ Billing Summary</button>
                    <button class="action-btn" onclick="searchArchive()">üìÅ Archive Search</button>
                    <button class="action-btn" onclick="judgeIntel()">‚öñÔ∏è Judge Intel</button>
                    <button class="action-btn" onclick="draftDocument()">üìù Draft Document</button>
                    <button class="action-btn" onclick="researchCase()">üîç Legal Research</button>
                    <button class="action-btn" onclick="endSession()">üèÅ End Session</button>
                    <button class="action-btn" onclick="clientComm()">üí¨ Client Communication</button>
                </div>
            </div>

            <div class="processing-mode">
                <h3>üß† Processing Mode</h3>
                <div class="mode-selector">
                    <button class="mode-btn active" onclick="setMode('normal')">‚ö° Normal</button>
                    <button class="mode-btn" onclick="setMode('deep')">üß† Deep Think</button>
                </div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #e2e8f0;">
                    <strong>Normal:</strong> Fast synthesis (2 AIs)<br>
                    <strong>Deep Think:</strong> Comprehensive analysis (3 AIs)
                </div>
            </div>

            <div class="token-usage" id="tokenUsage">
                <h4>Token Usage</h4>
                <div style="font-size: 0.8rem; margin-bottom: 0.5rem;">Claude: <span id="claudeUsage">0</span>k / 200k</div>
                <div class="token-bar"><div class="token-fill" id="claudeBar" style="width: 0%"></div></div>
                
                <div style="font-size: 0.8rem; margin-bottom: 0.5rem;">OpenAI: <span id="openaiUsage">0</span>k / 150k</div>
                <div class="token-bar"><div class="token-fill" id="openaiBar" style="width: 0%"></div></div>
                
                <div style="font-size: 0.8rem; margin-bottom: 0.5rem;">Gemini: <span id="geminiUsage">0</span>k / 100k</div>
                <div class="token-bar"><div class="token-fill" id="geminiBar" style="width: 0%"></div></div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="message">
                    <strong style="color: #d4af37;">Welcome to ESQs</strong><br>
                    Your Enhanced Synthesized Quintessential System is ready. Cynthia, your AI legal assistant, is standing by to help with case analysis, research, document drafting, and strategic planning.
                    <br><br>
                    <em>üîë Set your API keys using the browser console: window.ESQS_API_KEYS = {OPENAI_API_KEY: 'your-key', CLAUDE_API_KEY: 'your-key', GEMINI_API_KEY: 'your-key'}</em>
                    <br><br>
                    <em style="color: #d4af37;">‚ö° Secret: Press Ctrl+Shift+Alt+B to access the Internal Code Builder (5-AI Collaboration)</em>
                </div>
            </div>

            <!-- CYNTHIA INTERFACE -->
            <div class="cynthia-interface" id="cynthiaInterface">
                <div class="cynthia-container">
                    <div class="cynthia-face" id="cynthiaFace">
                        <div class="cynthia-eyes"></div>
                        <div class="cynthia-nose"></div>
                        <div class="cynthia-mouth"></div>
                        <div class="face-reflection"></div>
                        <div class="query-reflection" id="queryReflection"></div>
                    </div>
                    
                    <div class="books-container" id="booksContainer">
                        <div class="book"></div>
                        <div class="book"></div>
                        <div class="book"></div>
                        <div class="book"></div>
                    </div>
                </div>
                
                <div class="cynthia-response" id="cynthiaResponse">
                    <div class="cynthia-label">Cynthia recommends:</div>
                    <div id="cynthiaContent">Ready to assist with your legal analysis...</div>
                </div>
            </div>

            <div class="query-input-area" id="queryInputArea">
                <div class="drag-overlay">üìé Drop files here to attach</div>
                <div class="file-preview" id="filePreview" style="display:none;"></div>
                <button class="attach-btn" id="attachBtn" onclick="document.getElementById('fileInput').click()" title="Attach file">üìé</button>
                <input type="file" id="fileInput" multiple style="display:none" onchange="handleFileSelect(event)">
                <textarea
                    class="query-input"
                    id="queryInput"
                    placeholder="Ask Cynthia anything about your legal matter..."
                    onkeydown="handleKeyPress(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendQuery()">Send to Cynthia</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <h3>üë§ Access Client</h3>
            <input type="text" class="modal-input" id="clientName" placeholder="Client Name">
            <input type="text" class="modal-input" id="caseNumber" placeholder="Case Number (optional)">
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="processClientAccess()">Access File</button>
                <button class="modal-btn secondary" onclick="closeModal('clientModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="researchModal">
        <div class="modal-content">
            <h3>üîç Legal Research</h3>
            <input type="text" class="modal-input" id="researchQuery" placeholder="Research topic or legal question">
            <select class="modal-input" id="researchType">
                <option value="case_law">Case Law</option>
                <option value="statutes">Utah Statutes</option>
                <option value="federal">Federal Law</option>
                <option value="judicial">Judicial Intelligence</option>
            </select>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="processResearch()">Start Research</button>
                <button class="modal-btn secondary" onclick="closeModal('researchModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- INTERNAL CODE BUILDER -->
    <div class="code-builder-modal" id="codeBuilderModal">
        <div class="code-builder-content">
            <div class="code-builder-header">
                <div class="code-builder-title">Internal Code Builder</div>
                <button class="code-builder-close" onclick="closeCodeBuilder()">&times;</button>
            </div>
            
            <div class="ai-status-grid" id="aiStatusGrid">
                <div class="ai-status-item" id="status-openai">
                    <div>OpenAI</div>
                    <div>Ready</div>
                </div>
                <div class="ai-status-item" id="status-anthropic">
                    <div>Anthropic</div>
                    <div>Ready</div>
                </div>
                <div class="ai-status-item" id="status-google">
                    <div>Google</div>
                    <div>Ready</div>
                </div>
                <div class="ai-status-item" id="status-perplexity">
                    <div>Perplexity</div>
                    <div>Ready</div>
                </div>
                <div class="ai-status-item" id="status-microsoft">
                    <div>Microsoft</div>
                    <div>Ready</div>
                </div>
            </div>

            <div class="code-builder-main">
                <div class="code-input-section">
                    <h4 style="color: #d4af37; margin-bottom: 10px;">üìù Code Request</h4>
                    <select class="language-selector" id="codeLanguage">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML/CSS</option>
                        <option value="react">React</option>
                        <option value="node">Node.js</option>
                        <option value="sql">SQL</option>
                        <option value="shell">Shell/Bash</option>
                        <option value="other">Other</option>
                    </select>
                    <textarea 
                        class="code-builder-textarea" 
                        id="codeRequest" 
                        placeholder="Describe the code you need in detail...

Example requests:
- Create a React component for a legal document viewer
- Build a Python script to parse court filing dates
- Generate SQL queries for case management database
- Create a Node.js API endpoint for client verification
- Build a responsive legal form with validation"></textarea>
                    
                    <div class="code-controls">
                        <button class="code-btn" onclick="generateCode()">ü§ñ Generate Code (5 AIs)</button>
                        <button class="code-btn" onclick="optimizeCode()">‚ö° Optimize Existing</button>
                        <button class="code-btn" onclick="explainCode()">üß† Explain Code</button>
                        <button class="code-btn" onclick="debugCode()">üîß Debug & Fix</button>
                        <button class="code-btn danger" onclick="clearCodeBuilder()">üóëÔ∏è Clear All</button>
                    </div>
                </div>

                <div class="code-output-section">
                    <h4 style="color: #d4af37; margin-bottom: 10px;">üíª Generated Code</h4>
                    <div class="code-controls">
                        <button class="code-btn" onclick="copyCode()">üìã Copy Code</button>
                        <button class="code-btn" onclick="downloadCode()">üíæ Download</button>
                        <button class="code-btn" onclick="createArtifact()">üé® Create Artifact</button>
                    </div>
                    <div class="code-output" id="codeOutput">Waiting for code generation...</div>
                </div>
            </div>

            <div class="code-builder-footer">
                <strong>‚ö° ESQs Internal Code Builder</strong> | 5-AI Collaboration: OpenAI + Anthropic + Google + Perplexity + Microsoft | 
                Hotkey: Ctrl+Shift+Alt+B | <span id="generationStats">Ready</span>
            </div>
        </div>
    </div>

    <script>
        /**
         * COMPLETE AI ROUTER INTEGRATION
         * Enhanced Synthesized Quintessential System - Core Intelligence
         */
        class AIRouter {
            constructor() {
                this.tokenLimits = {
                    claude: 200000,
                    gemini: 100000,
                    openai: 150000,
                    synthesis: 300000
                };
                
                this.tokenUsage = this.loadTokenUsage();
                this.apiKeys = this.loadSecureAPIKeys();
                
                this.aiCapabilities = {
                    claude: {
                        strengths: ['legal reasoning', 'case analysis', 'complex logic', 'strategy'],
                        speed: 'medium',
                        cost: 'high',
                        quality: 'highest'
                    },
                    gemini: {
                        strengths: ['document processing', 'quick summaries', 'google integration', 'fast queries'],
                        speed: 'fast',
                        cost: 'low',
                        quality: 'good'
                    },
                    openai: {
                        strengths: ['document generation', 'creative writing', 'general tasks', 'code'],
                        speed: 'medium',
                        cost: 'medium',
                        quality: 'high'
                    }
                };

                console.log('üîí Initializing secure AI Router...');
                this.validateAPIKeys();
                console.log('‚úÖ AI Router initialized securely');
            }

            loadSecureAPIKeys() {
                console.log('üåê Browser environment detected');
                console.log('üí° For local testing, set window.ESQS_API_KEYS with your API keys');
                
                if (typeof window !== 'undefined' && window.ESQS_API_KEYS) {
                    return {
                        claude: window.ESQS_API_KEYS.CLAUDE_API_KEY || null,
                        openai: window.ESQS_API_KEYS.OPENAI_API_KEY || null,
                        gemini: window.ESQS_API_KEYS.GEMINI_API_KEY || null
                    };
                } else if (typeof process !== 'undefined' && process.env) {
                    return {
                        claude: process.env.CLAUDE_API_KEY || null,
                        openai: process.env.OPENAI_API_KEY || null,
                        gemini: process.env.GEMINI_API_KEY || null
                    };
                }
                
                console.log('‚ö†Ô∏è No API keys found in environment variables');
                console.log('üí° For local testing, set window.ESQS_API_KEYS in browser console');
                return { claude: null, openai: null, gemini: null };
            }

            validateAPIKeys() {
                const status = {};
                ['openai', 'claude', 'gemini'].forEach(ai => {
                    if (this.apiKeys[ai]) {
                        status[ai] = '‚úÖ Available';
                        console.log(`‚úÖ ${ai.toUpperCase()}: API key loaded`);
                    } else {
                        status[ai] = '‚ö†Ô∏è Missing';
                        console.log(`‚ö†Ô∏è ${ai.toUpperCase()}: API key missing`);
                    }
                });
                this.updateStatusIndicators(status);
                return status;
            }

            updateStatusIndicators(status) {
                const indicators = document.getElementById('statusIndicators');
                if (!indicators) return;

                const aiNames = ['Cynthia', 'Claude', 'OpenAI', 'Gemini'];
                const statusKeys = [null, 'claude', 'openai', 'gemini'];
                
                indicators.innerHTML = '';
                
                aiNames.forEach((name, index) => {
                    const statusKey = statusKeys[index];
                    let statusClass = 'status-offline';
                    
                    if (name === 'Cynthia') {
                        // Cynthia is online if any AI is available
                        const hasAnyAI = Object.values(status).some(s => s.includes('‚úÖ'));
                        statusClass = hasAnyAI ? 'status-ready' : 'status-offline';
                    } else if (statusKey && status[statusKey]) {
                        statusClass = status[statusKey].includes('‚úÖ') ? 'status-ready' : 'status-error';
                    }
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'status-item';
                    indicator.innerHTML = `<span class="${statusClass}">‚óè</span> ${name}`;
                    indicators.appendChild(indicator);
                });
            }

            async routeQuery(query, processingMode = 'normal') {
                try {
                    console.log(`üéØ Routing query (${processingMode} mode): ${query}...`);
                    return await this.synthesizeResponse(query, processingMode);
                } catch (error) {
                    console.error('Routing error:', error);
                    throw new Error(`AI synthesis failed: ${error.message}`);
                }
            }

            async synthesizeResponse(query, processingMode = 'normal') {
                const startTime = Date.now();
                
                try {
                    const aisToUse = this.selectAIsForMode(query, processingMode);
                    console.log(`ü§ñ Using AIs: ${aisToUse.join(', ')}`);
                    
                    const promises = aisToUse.map(ai => 
                        this.sendToAI(query, ai).catch(error => ({
                            error: true,
                            ai: ai,
                            message: error.message
                        }))
                    );

                    const responses = await Promise.all(promises);
                    const validResponses = responses.filter(r => !r.error);
                    
                    if (validResponses.length === 0) {
                        throw new Error('All AIs failed to respond');
                    }

                    console.log(`‚úÖ Synthesis complete: ${validResponses.length}/${responses.length} AIs responded`);
                    
                    const synthesized = this.combineResponses(validResponses, query, processingMode);
                    
                    this.updateTokenUsage(synthesized.totalTokens, aisToUse);
                    
                    return {
                        content: synthesized.content,
                        aiUsed: `${processingMode === 'deep' ? 'Deep Think' : 'Normal'} Synthesis`,
                        tokensUsed: synthesized.totalTokens,
                        responseTime: Date.now() - startTime,
                        confidence: synthesized.confidence,
                        contributingAIs: validResponses.map(r => r.aiUsed),
                        processingMode: processingMode
                    };

                } catch (error) {
                    console.error('Synthesis error:', error);
                    throw new Error(`Synthesis failed: ${error.message}`);
                }
            }

            selectAIsForMode(query, processingMode) {
                const lowerQuery = query.toLowerCase();
                
                if (processingMode === 'deep') {
                    if (this.hasLegalComplexity(query)) {
                        return ['claude', 'gemini', 'openai'];
                    }
                    return ['claude', 'gemini', 'openai'];
                } else {
                    if (this.hasLegalComplexity(query)) {
                        return ['claude', 'gemini'];
                    }
                    
                    if (lowerQuery.includes('draft') || lowerQuery.includes('write')) {
                        return ['openai', 'claude'];
                    }
                    
                    if (lowerQuery.includes('quick') || lowerQuery.includes('summary')) {
                        return ['gemini', 'openai'];
                    }
                    
                    return ['claude', 'gemini'];
                }
            }

            hasLegalComplexity(query) {
                const complexityIndicators = [
                    /\b(analyze|analysis)\b.*\b(case|legal|law)\b/i,
                    /\b(motion|brief|pleading)\b/i,
                    /\b(judge|court|jurisdiction)\b/i,
                    /\b(precedent|case law|statute)\b/i,
                    /\b(liability|damages|evidence)\b/i,
                    /\b(constitutional|amendment|rights)\b/i,
                    /\b(contract|agreement|clause)\b/i
                ];

                return complexityIndicators.some(pattern => pattern.test(query));
            }

            async sendToAI(query, aiName) {
                const startTime = Date.now();
                
                try {
                    let response;
                    
                    switch (aiName) {
                        case 'claude':
                            response = await this.sendToClaude(query);
                            break;
                        case 'gemini':
                            response = await this.sendToGemini(query);
                            break;
                        case 'openai':
                            response = await this.sendToOpenAI(query);
                            break;
                        default:
                            throw new Error(`Unknown AI: ${aiName}`);
                    }

                    const tokensUsed = this.estimateTokens(query + response.content);

                    return {
                        content: response.content,
                        aiUsed: this.capitalize(aiName),
                        tokensUsed: tokensUsed,
                        responseTime: Date.now() - startTime,
                        confidence: response.confidence || 85
                    };

                } catch (error) {
                    console.error(`‚ùå ${aiName} error:`, error);
                    throw new Error(`${aiName} unavailable: ${error.message}`);
                }
            }

            async sendToClaude(query) {
                if (!this.apiKeys.claude) {
                    throw new Error('Claude API key not available - check environment variables');
                }

                console.log('üîó Connecting to Claude API...');

                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKeys.claude,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-sonnet-20240229',
                            max_tokens: 4000,
                            messages: [{
                                role: 'user',
                                content: `As a legal AI assistant, provide comprehensive analysis for: ${query}\n\nFocus on Utah law where applicable, include strategic recommendations, and maintain professional legal standards.`
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    return {
                        content: `**Claude Legal Analysis:**\n\n${data.content[0].text}`,
                        confidence: 92
                    };

                } catch (error) {
                    console.error('Claude API call failed:', error);
                    return await this.fallbackClaude(query);
                }
            }

            async sendToGemini(query) {
                if (!this.apiKeys.gemini) {
                    throw new Error('Gemini API key not available - check environment variables');
                }

                console.log('üîó Connecting to Gemini API...');

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKeys.gemini}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `As a legal AI assistant, provide quick analysis for: ${query}\n\nFocus on key points, procedural requirements, and actionable recommendations for Utah legal practice.`
                                }]
                            }],
                            generationConfig: {
                                maxOutputTokens: 2048,
                                temperature: 0.3
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Gemini API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    return {
                        content: `**Gemini Quick Analysis:**\n\n${data.candidates[0].content.parts[0].text}`,
                        confidence: 88
                    };

                } catch (error) {
                    console.error('Gemini API call failed:', error);
                    return await this.fallbackGemini(query);
                }
            }

            async sendToOpenAI(query) {
                if (!this.apiKeys.openai) {
                    throw new Error('OpenAI API key not available - check environment variables');
                }

                console.log('üîó Connecting to OpenAI API...');

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKeys.openai}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: [{
                                role: 'system',
                                content: 'You are a professional legal AI assistant specializing in Utah law and legal practice management. Provide structured, actionable legal analysis.'
                            }, {
                                role: 'user',
                                content: query
                            }],
                            max_tokens: 3000,
                            temperature: 0.3
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OpenAI API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    return {
                        content: `**OpenAI Legal Response:**\n\n${data.choices[0].message.content}`,
                        confidence: 85
                    };

                } catch (error) {
                    console.error('OpenAI API call failed:', error);
                    return await this.fallbackOpenAI(query);
                }
            }

            // Fallback simulated responses for CORS issues or API failures
            async fallbackClaude(query) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return {
                    content: `**Claude Legal Analysis:**\n\nRegarding "${query}" in Utah jurisdiction:\n\nThis matter requires careful consideration of Utah state law and relevant precedents. Key legal issues include statutory compliance, procedural requirements, and potential strategic implications.\n\n**Recommended Actions:**\n- Review applicable Utah statutes\n- Analyze relevant case precedents\n- Consider jurisdiction-specific procedures\n- Develop strategic approach\n\n*This analysis is for informational purposes only.*`,
                    confidence: 92
                };
            }

            async fallbackGemini(query) {
                await new Promise(resolve => setTimeout(resolve, 800));
                return {
                    content: `**Gemini Quick Analysis:**\n\n‚úÖ **Query Processed:** ${query}\n\nüìã **Key Points:**\n‚Ä¢ Utah legal framework identified\n‚Ä¢ Procedural requirements noted\n‚Ä¢ Timeline considerations flagged\n‚Ä¢ Documentation needs assessed\n\n‚ö° **Quick Recommendations:**\n1. Research current Utah statutes\n2. Check local court rules\n3. Prepare supporting documentation\n4. Consider filing deadlines\n\n*Fast analysis for immediate decision support.*`,
                    confidence: 88
                };
            }

            async fallbackOpenAI(query) {
                await new Promise(resolve => setTimeout(resolve, 1200));
                return {
                    content: `**OpenAI Legal Response:**\n\nAnalyzing: "${query}"\n\nThis legal matter involves several important considerations that require systematic approach:\n\n**Structured Analysis:**\n\n1. **Legal Framework:** Utah state law governs this matter\n2. **Procedural Requirements:** Must comply with court rules\n3. **Strategic Considerations:** Multiple approach options available\n4. **Timeline Factors:** Statutory deadlines apply\n\n**Recommended Next Steps:**\n- Comprehensive legal research\n- Document preparation and review\n- Strategic planning session\n- Client consultation\n\nThis framework provides a solid foundation for addressing your legal needs.`,
                    confidence: 85
                };
            }

            combineResponses(responses, originalQuery, processingMode) {
                let combinedContent = `**Cynthia's ${processingMode === 'deep' ? 'Deep Think Analysis' : 'Analysis'}:**\n\n`;
                let totalTokens = 0;
                let totalConfidence = 0;

                responses.sort((a, b) => (b.confidence || 0) - (a.confidence || 0));

                if (processingMode === 'deep') {
                    combinedContent += `**Comprehensive Analysis of:** "${originalQuery}"\n\n`;
                    
                    responses.forEach((response, index) => {
                        const aiName = response.aiUsed;
                        combinedContent += `### ${aiName}:\n`;
                        combinedContent += `${response.content}\n\n`;
                        
                        totalTokens += response.tokensUsed || 0;
                        totalConfidence += response.confidence || 85;
                    });
                    
                    combinedContent += `---\n\n### üß† **Deep Think Synthesis:**\n`;
                    combinedContent += `This comprehensive analysis combines insights from ${responses.length} AI systems `;
                    combinedContent += `to provide thorough coverage of: "${originalQuery}"\n\n`;
                    combinedContent += `**Key Convergent Points:** All AIs agree on fundamental analysis\n`;
                    combinedContent += `**Confidence Level:** ${Math.round(totalConfidence / responses.length)}% (High)\n`;
                    combinedContent += `**Recommendation:** Proceed with confidence based on multi-AI consensus`;
                    
                } else {
                    responses.forEach((response, index) => {
                        if (index === 0) {
                            combinedContent += `### ${response.aiUsed}:\n`;
                            combinedContent += `${response.content}\n\n`;
                        } else {
                            combinedContent += `### Supporting Analysis (${response.aiUsed}):\n`;
                            combinedContent += `${response.content}\n\n`;
                        }
                        
                        totalTokens += response.tokensUsed || 0;
                        totalConfidence += response.confidence || 85;
                    });
                    
                    if (responses.length > 1) {
                        combinedContent += `---\n\n**‚ö° Quick Synthesis:** `;
                        combinedContent += `Combined analysis from ${responses.length} AIs for balanced perspective on: "${originalQuery}"`;
                    }
                }

                return {
                    content: combinedContent,
                    totalTokens: totalTokens,
                    confidence: Math.round(totalConfidence / responses.length)
                };
            }

            updateTokenUsage(tokensUsed, aisUsed) {
                aisUsed.forEach(ai => {
                    this.tokenUsage[ai] = (this.tokenUsage[ai] || 0) + Math.round(tokensUsed / aisUsed.length);
                });
                
                this.saveTokenUsage();
                this.updateTokenDisplay();
            }

            updateTokenDisplay() {
                ['claude', 'openai', 'gemini'].forEach(ai => {
                    const usage = this.tokenUsage[ai] || 0;
                    const limit = this.tokenLimits[ai];
                    const percentage = Math.min((usage / limit) * 100, 100);
                    
                    const usageElement = document.getElementById(`${ai}Usage`);
                    const barElement = document.getElementById(`${ai}Bar`);
                    
                    if (usageElement) usageElement.textContent = Math.round(usage / 1000);
                    if (barElement) barElement.style.width = `${percentage}%`;
                });
            }

            estimateTokens(text) {
                return Math.ceil(text.length / 4);
            }

            loadTokenUsage() {
                try {
                    const saved = localStorage.getItem('esqs-token-usage');
                    return saved ? JSON.parse(saved) : {};
                } catch {
                    return {};
                }
            }

            saveTokenUsage() {
                localStorage.setItem('esqs-token-usage', JSON.stringify(this.tokenUsage));
            }

            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            getUsageStats() {
                return {
                    tokenUsage: this.tokenUsage,
                    limits: this.tokenLimits,
                    percentUsed: Object.keys(this.tokenLimits).reduce((acc, ai) => {
                        acc[ai] = Math.round(((this.tokenUsage[ai] || 0) / this.tokenLimits[ai]) * 100);
                        return acc;
                    }, {})
                };
            }

            resetUsage() {
                this.tokenUsage = {};
                this.saveTokenUsage();
                this.updateTokenDisplay();
            }
        }

        // Global router instance
        const aiRouter = new AIRouter();

        // Global function for the UI
        async function routeQuery(query, processingMode) {
            return await aiRouter.routeQuery(query, processingMode);
        }

        /**
         * UI CONTROL FUNCTIONS
         */
        let currentMode = 'normal';
        let isProcessing = false;

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function sendQuery() {
            if (isProcessing) return;
            
            const input = document.getElementById('queryInput');
            const query = input.value.trim();
            
            if (!query) return;

            setProcessing(true);
            addMessage(`You: ${query}`, 'user');
            input.value = '';

            startCynthiaThinking(query);

            try {
                const response = await routeQuery(query, currentMode);
                showCynthiaResponse(response.content);
                
            } catch (error) {
                console.error('Query error:', error);
                showCynthiaResponse("I apologize, but I'm having trouble accessing my AI capabilities right now. Please ensure your API keys are properly configured and try again.");
            } finally {
                setProcessing(false);
            }
        }

        function setProcessing(processing) {
            isProcessing = processing;
            const sendBtn = document.getElementById('sendBtn');
            const queryInput = document.getElementById('queryInput');
            
            sendBtn.disabled = processing;
            queryInput.disabled = processing;
            
            if (processing) {
                sendBtn.textContent = 'Processing...';
            } else {
                sendBtn.textContent = 'Send to Cynthia';
            }
        }

        function startCynthiaThinking(query) {
            const face = document.getElementById('cynthiaFace');
            const reflection = document.getElementById('queryReflection');
            const response = document.getElementById('cynthiaResponse');
            
            response.classList.remove('show');
            face.classList.add('thinking');
            
            reflection.textContent = query.substring(0, 20) + (query.length > 20 ? '...' : '');
            reflection.classList.add('active');
            
            setTimeout(() => {
                reflection.classList.remove('active');
            }, 4000);
        }

        function enrichLinks(html) {
            // Make bare URLs clickable
            html = html.replace(/(https?:\/\/[^\s<"']+)/g, (url) => {
                if (url.match(/^https?:\/\/[^"]*"/) || html.indexOf('href="' + url) >= 0) return url;
                return `<a href="${url}" target="_blank" rel="noopener" style="color:#d4af37;text-decoration:underline;">${url}</a>`;
            });
            // Make case numbers clickable ‚Üí XChange lookup
            html = html.replace(/\b(\d{9})\b/g, (num) => {
                return `<a href="https://www.utcourts.gov/xchange/" target="_blank" rel="noopener" title="Look up case ${num} on XChange" style="color:#d4af37;text-decoration:underline;cursor:pointer;">${num}</a>`;
            });
            // Make markdown links [text](url) into real links
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g,
                '<a href="$2" target="_blank" rel="noopener" style="color:#d4af37;text-decoration:underline;">$1</a>');
            // Ensure existing <a> tags open in new tab
            html = html.replace(/<a\s+href=/g, '<a target="_blank" rel="noopener" href=');
            return html;
        }

        function showCynthiaResponse(content) {
            const face = document.getElementById('cynthiaFace');
            const books = document.getElementById('booksContainer');
            const response = document.getElementById('cynthiaResponse');
            const responseContent = document.getElementById('cynthiaContent');

            face.classList.remove('thinking');
            books.classList.add('dropping');

            setTimeout(() => {
                responseContent.innerHTML = enrichLinks(content);
                response.classList.add('show');

                setTimeout(() => {
                    books.classList.remove('dropping');
                }, 1000);
            }, 1200);
        }

        function addMessage(content, type = '') {
            const messages = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = enrichLinks(content);
            const ts = document.createElement('span');
            ts.className = 'message-timestamp';
            const now = new Date();
            const month = now.toLocaleString('en-US', { month: 'short', timeZone: 'America/Denver' });
            const day = now.toLocaleString('en-US', { day: 'numeric', timeZone: 'America/Denver' });
            const time = now.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Denver' });
            ts.textContent = `${month} ${day}, ${time}`;
            message.appendChild(ts);
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendQuery();
            }
        }

        // ‚îÄ‚îÄ FILE UPLOAD / DRAG-DROP ‚îÄ‚îÄ
        let pendingFiles = [];

        (function initDragDrop() {
            const area = document.getElementById('queryInputArea');
            if (!area) return;
            ['dragenter', 'dragover'].forEach(evt => {
                area.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); area.classList.add('drag-over'); });
            });
            ['dragleave', 'drop'].forEach(evt => {
                area.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); area.classList.remove('drag-over'); });
            });
            area.addEventListener('drop', e => {
                const files = Array.from(e.dataTransfer.files);
                if (files.length) addPendingFiles(files);
            });
        })();

        function handleFileSelect(event) {
            addPendingFiles(Array.from(event.target.files));
            event.target.value = '';
        }

        function addPendingFiles(files) {
            pendingFiles.push(...files);
            renderFilePreview();
        }

        function removePendingFile(index) {
            pendingFiles.splice(index, 1);
            renderFilePreview();
        }

        function renderFilePreview() {
            const preview = document.getElementById('filePreview');
            if (pendingFiles.length === 0) { preview.style.display = 'none'; preview.innerHTML = ''; return; }
            preview.style.display = 'flex';
            preview.innerHTML = pendingFiles.map((f, i) =>
                `<span class="file-chip">üìÑ ${f.name} (${(f.size / 1024).toFixed(0)}KB) <span class="remove-file" onclick="removePendingFile(${i})">‚úï</span></span>`
            ).join('');
        }

        async function uploadFiles() {
            if (pendingFiles.length === 0) return [];
            const results = [];
            for (const file of pendingFiles) {
                try {
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('case_id', 'chat-upload');
                    fd.append('doc_type', file.type || 'unknown');
                    const res = await fetch('https://api.esqs-law.com/api/documents/upload', { method: 'POST', body: fd });
                    const data = await res.json();
                    if (data.success) results.push({ name: file.name, id: data.id, key: data.r2_key });
                    else console.error('Upload failed:', file.name, data.error);
                } catch (e) { console.error('Upload error:', file.name, e); }
            }
            pendingFiles = [];
            renderFilePreview();
            return results;
        }

        // Patch sendQuery to handle file uploads
        const _origSendQuery = sendQuery;
        sendQuery = async function() {
            if (pendingFiles.length > 0) {
                const input = document.getElementById('queryInput');
                const query = input.value.trim();
                if (!query && pendingFiles.length > 0) {
                    input.value = `Attached ${pendingFiles.length} file(s): ${pendingFiles.map(f => f.name).join(', ')}`;
                }
                setProcessing(true);
                addMessage(`You: ${input.value.trim()} üìé (${pendingFiles.length} file${pendingFiles.length > 1 ? 's' : ''} attached)`, 'user');
                const uploaded = await uploadFiles();
                if (uploaded.length > 0) {
                    const fileNote = uploaded.map(u => u.name).join(', ');
                    input.value = (query ? query + '\n' : '') + `[Uploaded files: ${fileNote}]`;
                }
                input.value = input.value || 'Files uploaded';
                setProcessing(false);
            }
            return _origSendQuery();
        };

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Quick action functions
        function accessClient() {
            showModal('clientModal');
        }

        function processClientAccess() {
            const clientName = document.getElementById('clientName').value;
            const caseNumber = document.getElementById('caseNumber').value;
            
            if (clientName) {
                closeModal('clientModal');
                addMessage(`Accessing client file: ${clientName}${caseNumber ? ' (Case: ' + caseNumber + ')' : ''}`, 'user');
                showCynthiaResponse(`I've accessed the file for ${clientName}${caseNumber ? ' for case #' + caseNumber : ''}. I'm ready to assist with case analysis, billing tracking, and document management. What would you like to work on first?`);
                
                // Clear form
                document.getElementById('clientName').value = '';
                document.getElementById('caseNumber').value = '';
            }
        }

        function startBilling() {
            addMessage("Checking billing status...", 'user');
            showCynthiaResponse("Current session: 2.5 hours active. Billing timer started at 12:01 PM. Recent activities include case research (45 min) and document review (30 min). Would you like me to generate a billing summary?");
        }

        function searchArchive() {
            const searchTerm = prompt("Search archive for:");
            if (searchTerm) {
                addMessage(`Searching archive: ${searchTerm}`, 'user');
                showCynthiaResponse(`I found 12 documents related to "${searchTerm}" in your archive. This includes 3 pleadings, 4 research memos, 2 client communications, and 3 court orders. Would you like me to analyze any specific documents?`);
            }
        }

        function judgeIntel() {
            addMessage("Requesting judicial intelligence...", 'user');
            showCynthiaResponse("Judge John J. Walton (Fifth Judicial District Court, Washington County): Procedural strictness: 85%. Requires exact Rule 7 compliance and has zero tolerance for procedural errors. Strictly enforces filing deadlines. Recommendation: Ensure all filings are meticulously formatted and submitted early.");
        }

        function draftDocument() {
            const docType = prompt("What type of document would you like to draft?");
            if (docType) {
                addMessage(`Draft request: ${docType}`, 'user');
                showCynthiaResponse(`I'll help you draft a ${docType}. Based on Utah law and best practices, I recommend starting with a comprehensive outline covering all required elements. Would you like me to begin with the standard format for this document type?`);
            }
        }

        function researchCase() {
            showModal('researchModal');
        }

        function processResearch() {
            const query = document.getElementById('researchQuery').value;
            const type = document.getElementById('researchType').value;
            
            if (query) {
                closeModal('researchModal');
                addMessage(`Legal research: ${query} (${type})`, 'user');
                showCynthiaResponse(`I've completed research on "${query}" focusing on ${type}. Found relevant cases and statutes. The research shows strong precedent for your position. Key findings include procedural requirements, statutory interpretation, and strategic recommendations. Would you like me to analyze any specific aspect in detail?`);
                
                // Clear form
                document.getElementById('researchQuery').value = '';
            }
        }

        function endSession() {
            addMessage("Ending current session...", 'user');
            showCynthiaResponse("Session summary: 3.2 billable hours. Activities completed: case analysis, legal research, document review. All work has been archived to the client folder. Time entry ready for Practice Panther. Would you like me to generate the billing narrative?");
        }

        function clientComm() {
            addMessage("Preparing client communication...", 'user');
            showCynthiaResponse("I can help draft professional client communications including status updates, strategy explanations, and next steps. I'll ensure the tone is appropriate and all communications maintain attorney-client privilege. What type of communication do you need?");
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // SECRET CODE BUILDER ACTIVATION - Ctrl+Shift+Alt+B
        let keysPressed = new Set();
        
        document.addEventListener('keydown', function(event) {
            keysPressed.add(event.code);
            
            // Check for the secret combination: Ctrl+Shift+Alt+B
            if (keysPressed.has('ControlLeft') && 
                keysPressed.has('ShiftLeft') && 
                keysPressed.has('AltLeft') && 
                keysPressed.has('KeyB')) {
                
                event.preventDefault();
                openCodeBuilder();
            }
        });
        
        document.addEventListener('keyup', function(event) {
            keysPressed.delete(event.code);
        });

        // CODE BUILDER FUNCTIONS
        function openCodeBuilder() {
            console.log('üîì ESQs Internal Code Builder activated!');
            document.getElementById('codeBuilderModal').style.display = 'block';
            document.getElementById('codeRequest').focus();
            
            // Flash the AI status to show activation
            document.querySelectorAll('.ai-status-item').forEach(item => {
                item.classList.add('active');
                setTimeout(() => item.classList.remove('active'), 1000);
            });
        }

        function closeCodeBuilder() {
            document.getElementById('codeBuilderModal').style.display = 'none';
        }

        async function generateCode() {
            const request = document.getElementById('codeRequest').value.trim();
            const language = document.getElementById('codeLanguage').value;
            
            if (!request) {
                alert('Please describe the code you need first.');
                return;
            }

            console.log('‚ö° Starting 5-AI code generation...');
            updateGenerationStats('Initializing 5-AI collaboration...');
            
            try {
                // Set all AIs to processing state
                setAllAIStatus('processing');
                
                const codeResult = await generate5AICode(request, language);
                
                document.getElementById('codeOutput').textContent = codeResult.code;
                updateGenerationStats(`Generated in ${codeResult.time}ms using ${codeResult.aiCount} AIs`);
                
                // Set all AIs back to ready
                setAllAIStatus('active');
                setTimeout(() => setAllAIStatus('ready'), 2000);
                
            } catch (error) {
                console.error('Code generation failed:', error);
                document.getElementById('codeOutput').textContent = `Error: ${error.message}`;
                updateGenerationStats('Generation failed');
                setAllAIStatus('ready');
            }
        }

        async function generate5AICode(request, language) {
            const startTime = Date.now();
            console.log(`ü§ñ Generating ${language} code with 5-AI collaboration...`);
            
            try {
                // Enhanced prompt for code generation
                const enhancedRequest = `As an expert ${language} developer, create production-ready code for: ${request}

Requirements:
- Clean, well-documented code
- Follow best practices for ${language}
- Include error handling where appropriate
- Add helpful comments
- Make it maintainable and scalable
- If it's a UI component, make it responsive and accessible
- If it's a backend function, include proper validation

Please provide complete, working code that can be used immediately.`;

                const response = await routeQuery(enhancedRequest, 'deep');
                
                const codeResult = {
                    code: extractCodeFromResponse(response.content),
                    time: Date.now() - startTime,
                    aiCount: response.contributingAIs ? response.contributingAIs.length : 5,
                    confidence: response.confidence
                };

                console.log(`‚úÖ Code generation completed: ${codeResult.aiCount} AIs, ${codeResult.time}ms`);
                return codeResult;
                
            } catch (error) {
                console.error('5-AI code generation failed:', error);
                throw new Error(`Code generation failed: ${error.message}`);
            }
        }

        function extractCodeFromResponse(content) {
            // Try to extract code blocks from markdown
            const codeBlockRegex = /```[\w]*\n([\s\S]*?)\n```/g;
            const matches = content.match(codeBlockRegex);
            
            if (matches && matches.length > 0) {
                // Return the first code block without the markdown syntax
                return matches[0].replace(/```[\w]*\n/, '').replace(/\n```$/, '');
            }
            
            // If no code blocks found, return the full content
            return content;
        }

        async function optimizeCode() {
            const currentCode = document.getElementById('codeOutput').textContent;
            if (!currentCode || currentCode === 'Waiting for code generation...') {
                alert('No code to optimize. Generate code first.');
                return;
            }

            const language = document.getElementById('codeLanguage').value;
            const optimizationRequest = `Optimize this ${language} code for better performance, readability, and maintainability:

\`\`\`${language}
${currentCode}
\`\`\`

Please provide:
1. The optimized code
2. Explanation of improvements made
3. Performance considerations
4. Best practices applied`;

            try {
                setAllAIStatus('processing');
                updateGenerationStats('Optimizing code with 5-AI analysis...');
                
                const result = await generate5AICode(optimizationRequest, language);
                document.getElementById('codeOutput').textContent = result.code;
                updateGenerationStats(`Optimized in ${result.time}ms`);
                
                setAllAIStatus('active');
                setTimeout(() => setAllAIStatus('ready'), 2000);
                
            } catch (error) {
                console.error('Code optimization failed:', error);
                updateGenerationStats('Optimization failed');
                setAllAIStatus('ready');
            }
        }

        async function explainCode() {
            const currentCode = document.getElementById('codeOutput').textContent;
            if (!currentCode || currentCode === 'Waiting for code generation...') {
                alert('No code to explain. Generate code first.');
                return;
            }

            const language = document.getElementById('codeLanguage').value;
            const explanationRequest = `Provide a detailed explanation of this ${language} code:

\`\`\`${language}
${currentCode}
\`\`\`

Please explain:
1. What the code does (high-level overview)
2. How each major section works
3. Key algorithms or patterns used
4. Dependencies and requirements
5. How to use/integrate this code
6. Potential improvements or considerations`;

            try {
                setAllAIStatus('processing');
                updateGenerationStats('Analyzing code with 5-AI intelligence...');
                
                const response = await routeQuery(explanationRequest, 'deep');
                document.getElementById('codeOutput').textContent = response.content;
                updateGenerationStats(`Analysis completed in ${response.responseTime}ms`);
                
                setAllAIStatus('active');
                setTimeout(() => setAllAIStatus('ready'), 2000);
                
            } catch (error) {
                console.error('Code explanation failed:', error);
                updateGenerationStats('Analysis failed');
                setAllAIStatus('ready');
            }
        }

        async function debugCode() {
            const currentCode = document.getElementById('codeOutput').textContent;
            if (!currentCode || currentCode === 'Waiting for code generation...') {
                alert('No code to debug. Generate code first.');
                return;
            }

            const language = document.getElementById('codeLanguage').value;
            const debugRequest = `Debug and fix this ${language} code:

\`\`\`${language}
${currentCode}
\`\`\`

Please:
1. Identify any bugs, errors, or potential issues
2. Fix the identified problems
3. Improve error handling
4. Add input validation where needed
5. Provide the corrected code
6. Explain what was fixed and why`;

            try {
                setAllAIStatus('processing');
                updateGenerationStats('Debugging with 5-AI error detection...');
                
                const result = await generate5AICode(debugRequest, language);
                document.getElementById('codeOutput').textContent = result.code;
                updateGenerationStats(`Debugging completed in ${result.time}ms`);
                
                setAllAIStatus('active');
                setTimeout(() => setAllAIStatus('ready'), 2000);
                
            } catch (error) {
                console.error('Code debugging failed:', error);
                updateGenerationStats('Debugging failed');
                setAllAIStatus('ready');
            }
        }

        function clearCodeBuilder() {
            if (confirm('Clear all code and start fresh?')) {
                document.getElementById('codeRequest').value = '';
                document.getElementById('codeOutput').textContent = 'Waiting for code generation...';
                updateGenerationStats('Ready');
                setAllAIStatus('ready');
            }
        }

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            if (code === 'Waiting for code generation...') {
                alert('No code to copy.');
                return;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code to clipboard');
            });
        }

        function downloadCode() {
            const code = document.getElementById('codeOutput').textContent;
            const language = document.getElementById('codeLanguage').value;
            
            if (code === 'Waiting for code generation...') {
                alert('No code to download.');
                return;
            }

            const extensions = {
                javascript: 'js',
                python: 'py',
                html: 'html',
                react: 'jsx',
                node: 'js',
                sql: 'sql',
                shell: 'sh',
                other: 'txt'
            };

            const extension = extensions[language] || 'txt';
            const filename = `esqs-generated-code.${extension}`;
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function createArtifact() {
            const code = document.getElementById('codeOutput').textContent;
            const language = document.getElementById('codeLanguage').value;
            
            if (code === 'Waiting for code generation...') {
                alert('No code to create artifact from.');
                return;
            }

            // This would integrate with Claude's artifact system if available
            console.log('Creating artifact from generated code...');
            alert(`Artifact creation would be implemented here for ${language} code.`);
        }

        function setAllAIStatus(status) {
            const statusTexts = {
                'ready': 'Ready',
                'processing': 'Working...',
                'active': 'Complete'
            };

            document.querySelectorAll('.ai-status-item').forEach(item => {
                item.className = `ai-status-item ${status}`;
                const statusDiv = item.querySelector('div:last-child');
                if (statusDiv) {
                    statusDiv.textContent = statusTexts[status] || status;
                }
            });
        }

        function updateGenerationStats(text) {
            document.getElementById('generationStats').textContent = text;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('cynthiaResponse').classList.add('show');
            }, 500);

            // Check for API keys periodically
            setInterval(() => {
                if (window.ESQS_API_KEYS && aiRouter) {
                    aiRouter.apiKeys = {
                        claude: window.ESQS_API_KEYS.CLAUDE_API_KEY || null,
                        openai: window.ESQS_API_KEYS.OPENAI_API_KEY || null,
                        gemini: window.ESQS_API_KEYS.GEMINI_API_KEY || null
                    };
                    aiRouter.validateAPIKeys();
                }
            }, 2000);
        });

        // Expose for debugging
        window.aiRouter = aiRouter;
    </script>
</body>
</html>